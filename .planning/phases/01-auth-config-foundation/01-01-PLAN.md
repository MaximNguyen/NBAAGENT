---
phase: 01-auth-config-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - nba_betting_agent/api/config.py
  - nba_betting_agent/api/deps.py
  - pyproject.toml
  - .env.example
autonomous: true

must_haves:
  truths:
    - "App crashes at startup if JWT_SECRET_KEY environment variable is missing"
    - "App crashes at startup if DASHBOARD_PASSWORD_HASH environment variable is missing"
    - "Settings are accessible via FastAPI dependency injection"
  artifacts:
    - path: "nba_betting_agent/api/config.py"
      provides: "Settings class with required env var validation"
      contains: "class Settings"
    - path: "nba_betting_agent/api/deps.py"
      provides: "Settings dependency for FastAPI routes"
      contains: "get_settings"
    - path: "pyproject.toml"
      provides: "New security dependencies declared"
      contains: "pyjwt"
    - path: ".env.example"
      provides: "Documentation of required environment variables"
      contains: "JWT_SECRET_KEY"
  key_links:
    - from: "nba_betting_agent/api/config.py"
      to: "pydantic_settings.BaseSettings"
      via: "inheritance"
      pattern: "class Settings\\(BaseSettings\\)"
    - from: "nba_betting_agent/api/deps.py"
      to: "nba_betting_agent/api/config.py"
      via: "import get_settings"
      pattern: "from.*config import.*get_settings"
---

<objective>
Create the configuration foundation: a pydantic-settings Settings class that loads secrets from environment variables and crashes at startup if required secrets are missing. Install new security dependencies (PyJWT, passlib, pydantic-settings). Add settings to FastAPI dependency injection.

Purpose: This is the foundation for all Phase 1 work. The auth rewrite (Plan 02) depends on Settings being available for JWT secrets and password hashes. Addresses AUTH-03 (env-based secrets) and AUTH-04 (fail-fast startup).

Output: config.py with Settings class, updated deps.py, updated pyproject.toml, updated .env.example
</objective>

<execution_context>
@/Users/maxim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/maxim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-auth-config-foundation/01-RESEARCH.md
@nba_betting_agent/api/deps.py
@nba_betting_agent/api/app.py
@pyproject.toml
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install security dependencies and create Settings class</name>
  <files>
    pyproject.toml
    nba_betting_agent/api/config.py
    .env.example
  </files>
  <action>
1. Update `pyproject.toml` — add to `[project.optional-dependencies] api` section:
   - `"pyjwt>=2.9.0"` (JWT encoding/decoding)
   - `"passlib[bcrypt]>=1.7.4"` (password hashing)
   - `"pydantic-settings>=2.0.0"` (env var management)
   Note: `python-dotenv>=1.0.0` is already in main dependencies.

2. Run `pip install -e ".[api,dev]"` to install new dependencies.

3. Create `nba_betting_agent/api/config.py` with:
   - Import from `pydantic` (Field) and `pydantic_settings` (BaseSettings, SettingsConfigDict)
   - Import `functools.lru_cache`
   - `class Settings(BaseSettings):` with these fields:
     - `jwt_secret_key: str = Field(..., min_length=32, description="Secret key for JWT signing. Generate with: openssl rand -hex 32")`
       — Required (no default), crashes if missing
     - `dashboard_password_hash: str = Field(..., description="Bcrypt hash of dashboard password")`
       — Required (no default), crashes if missing
     - `jwt_algorithm: str = Field(default="HS256")`
     - `access_token_expire_minutes: int = Field(default=60, ge=5, le=1440)`
     - `refresh_token_expire_days: int = Field(default=7, ge=1, le=30)`
     - `environment: str = Field(default="development")`
   - `model_config = SettingsConfigDict(env_file=".env", env_file_encoding="utf-8", case_sensitive=False, extra="ignore")`
   - `@lru_cache` decorated `def get_settings() -> Settings:` that returns `Settings()`

4. Update `.env.example` — add a new section BEFORE "Display Settings" with heading "Authentication Secrets (REQUIRED - app crashes if missing)":
   - `JWT_SECRET_KEY=` with comment: "Generate with: openssl rand -hex 32"
   - `DASHBOARD_PASSWORD_HASH=` with comment explaining how to generate bcrypt hash
   - `ACCESS_TOKEN_EXPIRE_MINUTES=60` (optional, has default)
   - `REFRESH_TOKEN_EXPIRE_DAYS=7` (optional, has default)
   Keep all existing env vars in the file.
  </action>
  <verify>
Run: `python -c "from nba_betting_agent.api.config import Settings; print('Settings class imported')"` — should print successfully.
Run: `python -c "from nba_betting_agent.api.config import get_settings; get_settings()"` — should CRASH with ValidationError about missing JWT_SECRET_KEY (proving fail-fast works).
Run: `JWT_SECRET_KEY=test-key-that-is-at-least-32-characters-long DASHBOARD_PASSWORD_HASH='$2b$12$test' python -c "from nba_betting_agent.api.config import get_settings; s = get_settings(); print(f'Algorithm: {s.jwt_algorithm}, Expire: {s.access_token_expire_minutes}min')"` — should print "Algorithm: HS256, Expire: 60min".
  </verify>
  <done>
Settings class exists in config.py. Instantiating without env vars crashes with clear error about missing JWT_SECRET_KEY. Instantiating with required env vars succeeds and provides correct defaults. PyJWT, passlib[bcrypt], pydantic-settings are installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Settings to FastAPI dependency injection</name>
  <files>
    nba_betting_agent/api/deps.py
  </files>
  <action>
Update `nba_betting_agent/api/deps.py`:
1. Add imports: `from typing import Annotated` (if not present), `from fastapi import Depends`
2. Add import: `from nba_betting_agent.api.config import Settings, get_settings`
3. Add function `def get_app_settings() -> Settings:` that returns `get_settings()` — this wraps the cached singleton for FastAPI DI
4. Add type alias: `SettingsDep = Annotated[Settings, Depends(get_app_settings)]`
5. Keep existing `get_db_session` function unchanged
6. Keep existing `AsyncIterator` and `AsyncSession` imports

Do NOT modify app.py startup validation yet — that belongs in Plan 02 when auth.py is rewritten, since the import chain changes together.
  </action>
  <verify>
Run: `python -c "from nba_betting_agent.api.deps import SettingsDep, get_app_settings; print('DI setup imported')"` — should succeed.
Run: `python -c "from nba_betting_agent.api.deps import get_db_session; print('Existing deps still work')"` — should succeed (no regression).
  </verify>
  <done>
deps.py exports SettingsDep and get_app_settings. Existing get_db_session dependency is unchanged. Settings are injectable into any FastAPI route via `settings: SettingsDep` parameter.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from nba_betting_agent.api.config import get_settings; get_settings()"` crashes with ValidationError (proves AUTH-04: fail-fast on missing secrets)
2. `JWT_SECRET_KEY=aaaa...32chars... DASHBOARD_PASSWORD_HASH='$2b$12$x' python -c "from nba_betting_agent.api.config import get_settings; print(get_settings().jwt_algorithm)"` prints "HS256"
3. `python -c "import jwt; print(jwt.__version__)"` shows >= 2.9.0 (PyJWT installed)
4. `python -c "from passlib.context import CryptContext; print('passlib ok')"` succeeds (passlib installed)
5. `python -c "from nba_betting_agent.api.deps import SettingsDep; print('DI ready')"` succeeds
6. Existing test suite still passes: `python -m pytest tests/ -x --timeout=30 -q` (no regressions from new deps)
</verification>

<success_criteria>
- config.py exists with Settings class requiring JWT_SECRET_KEY and DASHBOARD_PASSWORD_HASH
- Missing required env vars cause immediate crash (ValidationError)
- PyJWT >= 2.9.0, passlib[bcrypt] >= 1.7.4, pydantic-settings >= 2.0.0 are installed
- deps.py provides SettingsDep for FastAPI route injection
- .env.example documents all required and optional auth env vars
- Existing functionality unchanged (no import errors, tests pass)
</success_criteria>

<output>
After completion, create `.planning/phases/01-auth-config-foundation/01-01-SUMMARY.md`
</output>
